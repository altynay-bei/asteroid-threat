<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Asteroid Impact - Science Touch Demo</title>

  <!-- Leaflet CSS (no install) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body { font-family: Arial, sans-serif; padding: 12px; line-height: 1.4; }
    #controls { margin-bottom: 10px; }
    #map { height: 480px; margin-top: 10px; border: 1px solid #ccc; }
    #results { margin-top: 10px; background: #f7f7f7; padding: 10px; border-radius: 6px; }
    label { display: inline-block; margin-right: 8px; }
    input[type="number"] { width: 100px; margin-right: 12px; }
    .small { font-size: 0.9em; color: #555; }
    .warn { color: #8a2b2b; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Asteroid Impact — Science-touch Demo</h2>

  <div id="controls">
    <label>Diameter (m): <input id="diameter" type="number" value="50" min="1"></label>
    <label>Velocity (km/s): <input id="velocity" type="number" value="20" min="0.1" step="0.1"></label>
    <label>Density (kg/m³): <input id="density" type="number" value="3000"></label>
    <button id="enableClick">Activate click-to-place impact</button>
    <span class="small">Click map to choose impact point once activated.</span>
  </div>

  <div id="map"></div>

  <div id="results">
    <div class="warn">Note: results are <em>approximate</em> order-of-magnitude estimates for demo purposes. Use validated models (ImpactEffects / Holsapple) for research.</div>
    <div id="numbers"></div>
    <div id="explanations" class="small"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // --- Setup map ---
    var map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var impactMarker = null;
    var impactCircle = null;
    var clickEnabled = false;

    // Utilities: format large numbers nicely
    function fmt(n) {
      if (n === null || n === undefined) return '-';
      if (Math.abs(n) < 1000) return n.toFixed(2);
      return n.toExponential(3);
    }

    // --- Physics / approximate models ---
    // mass from diameter and density
    function computeMass(diameter_m, density) {
      var r = diameter_m / 2.0;
      var volume = (4/3) * Math.PI * Math.pow(r, 3); // m^3
      return density * volume; // kg
    }

    // kinetic energy J = 0.5 m v^2 (v in m/s)
    function computeEnergyJ(mass, velocity_m_s) {
      return 0.5 * mass * velocity_m_s * velocity_m_s;
    }

    // Convert J to megatons of TNT (1 MT ≈ 4.184e15 J)
    function toMegatons(energyJ) {
      return energyJ / 4.184e15;
    }

    // --- Simple approximate crater & blast scaling (order-of-magnitude) ---
    // These are simplified empirical-style scalings for demo:
    // - crater diameter (m): scales roughly with energy^(1/4)
    // - blast radius for heavy structural damage (km): scales roughly with energy^(1/3)
    // IMPORTANT: These are approximate for visualization / educational use only.
    function estimateCraterDiameter_m(energyJ) {
      // constant chosen so estimates are reasonable on demo scales
      // crater ~ C * E^(1/4)
      var C = 1.6; // tuning constant for demo (order-of-magnitude)
      return C * Math.pow(energyJ, 0.25);
    }

    function estimateBlastRadius_km(energyMegatons) {
      // blast radius (km) for heavy structural damage (very approximate)
      // R ~ K * (Yield)^(1/3)
      var K = 8.5; // tuning constant (gives plausible demo numbers)
      return K * Math.pow(Math.max(energyMegatons, 0.0001), 1/3);
    }

    // Very simple water-impact check (uses lat/lng to test if near ocean)
    // For demo: treat tile values from map layers unavailable offline; instead use a heuristic:
    function isWaterImpact(latlng) {
      // crude heuristic: if lat is within ocean-dominant bands and not near known land latitudes.
      // This is only a heuristic for demo. For accurate results use coastline GeoJSON (USGS).
      var lat = Math.abs(latlng.lat);
      // if lat close to poles or in mid-latitude, we can't be sure; use a simple test:
      // We'll classify as "ocean" if longitude isn't extreme and lat not close to major land latitudes.
      // NOTE: This is a placeholder. Replace with coastline checks for real app.
      return (lat > 60) ? false : (lat < 55 && lat > 10) ? true : false;
    }

    // --- Visual update when user clicks map ---
    function onMapClick(e) {
      if (!clickEnabled) return;

      // remove prior marker/circle
      if (impactMarker) map.removeLayer(impactMarker);
      if (impactCircle) map.removeLayer(impactCircle);

      impactMarker = L.marker(e.latlng).addTo(map);
      impactMarker.bindPopup("Impact point").openPopup();

      // read inputs
      var diameter = parseFloat(document.getElementById('diameter').value);
      var velocity_kms = parseFloat(document.getElementById('velocity').value);
      var density = parseFloat(document.getElementById('density').value);

      if (isNaN(diameter) || isNaN(velocity_kms) || isNaN(density)) {
        document.getElementById('numbers').innerHTML = '<span class="warn">Please enter valid numeric inputs.</span>';
        return;
      }

      // compute mass & energy
      var mass = computeMass(diameter, density); // kg
      var velocity_ms = velocity_kms * 1000.0; // convert
      var energyJ = computeEnergyJ(mass, velocity_ms);
      var energyMT = toMegatons(energyJ);

      // approximate crater & blast
      var crater_m = estimateCraterDiameter_m(energyJ);
      var blast_km = estimateBlastRadius_km(energyMT);

      // Draw an impact circle (visualizing crater/blast). We'll show blast radius as circle on map (in meters)
      var blast_m = blast_km * 1000;
      impactCircle = L.circle(e.latlng, {
        color: 'orangered',
        fillColor: '#ffb3a6',
        fillOpacity: 0.25,
        radius: blast_m
      }).addTo(map);

      // Show numbers
      var html = '';
      html += `<b>Impact location:</b> ${e.latlng.lat.toFixed(3)}, ${e.latlng.lng.toFixed(3)}<br>`;
      html += `<b>Inputs:</b> diameter ${diameter} m, velocity ${velocity_kms} km/s, density ${density} kg/m³<br><br>`;
      html += `<b>Mass:</b> ${fmt(mass)} kg<br>`;
      html += `<b>Kinetic energy:</b> ${fmt(energyJ)} J (${energyMT.toFixed(2)} megatons TNT)<br>`;
      html += `<b>Estimated crater diameter (order-of-magnitude):</b> ${Math.round(crater_m).toLocaleString()} m<br>`;
      html += `<b>Estimated heavy-damage blast radius (order-of-magnitude):</b> ${blast_km.toFixed(1)} km<br>`;

      // simple water/ocean heuristic for demo
      var water = isWaterImpact(e.latlng);
      html += `<br><b>Water impact heuristic:</b> ${water ? 'Probably OVER OCEAN — tsunami possible (requires hydrodynamic model)' : 'Probably OVER LAND — blast/seismic/airburst effects more likely'}<br>`;

      document.getElementById('numbers').innerHTML = html;

      // Explanation text
      document.getElementById('explanations').innerHTML =
        `<b>Notes:</b> Energy = 0.5·m·v². Crater and blast numbers are <em>very approximate</em> scalings used for visualization. ` +
        `For rigorous results use detailed models (ImpactEffects, Holsapple scaling, and tsunami hydrodynamics).`;

      // Zoom to show the blast radius visually (cap zoom-out)
      var desiredZoom = map.getBoundsZoom(impactCircle.getBounds(), true);
      map.fitBounds(impactCircle.getBounds(), { maxZoom: 6 });
    }

    // attach click handler
    map.on('click', onMapClick);

    // Enable button toggles click activation
    document.getElementById('enableClick').addEventListener('click', function() {
      clickEnabled = !clickEnabled;
      this.textContent = clickEnabled ? 'Click-to-place: ON (click map)' : 'Activate click-to-place impact';
      this.style.background = clickEnabled ? '#d9534f' : '';
    });

    // OPTIONAL: sample preset quick button to set example values (demo)
    // Add a small keyboard shortcut: press "1" to set example and show explanatory note.
    window.addEventListener('keydown', function(e) {
      if (e.key === '1') {
        document.getElementById('diameter').value = 50;
        document.getElementById('velocity').value = 20;
        document.getElementById('density').value = 3000;
        alert('Preset: 50 m, 20 km/s (press Activate then click map).');
      }
    });

  </script>
</body>
</html>
